# מערכת ניהול חשבוניות עם iCount

## סקירה כללית

מערכת ניהול חשבוניות משולבת עם iCount, תומכת בעבודה אופליין ומסונכרנת אוטומטית.

## תכונות עיקריות

### סוגי מסמכים נתמכים
- **חשבונית (Invoice)** - מסמך לדרישת תשלום
- **חשבונית מס קבלה (Invoice Receipt)** - מסמך משולב - חשבונית + אישור תשלום
- **קבלה (Receipt)** - אישור על תשלום שהתקבל
- **חשבונית זיכוי (Credit)** - זיכוי כספי ללקוח

### יכולות המערכת
✅ הפקת חשבוניות ישירות מהזמנות
✅ סנכרון דו-כיווני עם iCount
✅ עבודה במצב אופליין
✅ רישום תשלומים
✅ מעקב אחר חובות לקוחות
✅ הורדת PDF והדפסה
✅ שליחת חשבוניות במייל

## התקנה והגדרה

### שלב 1: הרצת Migration
```bash
npm run dev
# גש ל: http://localhost:3000/api/migrate/invoices (POST request)
```

או דרך Supabase:
```sql
-- רוץ את הקובץ migrations/006_invoices_system.sql
```

### שלב 2: הגדרת פרטי iCount

#### אופציה א': משתני סביבה (מומלץ)
צור קובץ `.env.local` והוסף:
```env
NEXT_PUBLIC_ICOUNT_CID=your_company_id
NEXT_PUBLIC_ICOUNT_USER=your_username
NEXT_PUBLIC_ICOUNT_PASS=your_password
```

#### אופציה ב': הגדרות במערכת
1. גש ל: `/settings`
2. הזן פרטי iCount
3. הפרטים יישמרו ב-localStorage + Supabase (גיבוי)

### שלב 3: הוספת פרטי לקוחות נוספים
וודא שללקוחות שלך יש:
- מספר ח.פ / ע.מ (tax_id)
- כתובת לחיוב (billing_address)
- עיר (city)
- מיקוד (postal_code)

## שימוש במערכת

### הפקת חשבונית מהזמנה

1. **מעמוד ההזמנות**:
   - לחץ על אייקון החשבונית (🧾) ליד ההזמנה
   - בחר סוג מסמך
   - לחץ "הפק חשבונית"

2. **מעמוד החשבוניות**:
   - לחץ "חשבונית חדשה"
   - בחר הזמנה
   - הגדר פרטים
   - שמור

### רישום תשלום

1. גש לדף החשבונית
2. לחץ "רשום תשלום"
3. הזן:
   - סכום התשלום
   - אמצעי תשלום
   - אסמכתא (אופציונלי)
4. אשר

המערכת תעדכן אוטומטית:
- סכום ששולם
- יתרה
- סטטוס תשלום (לא שולם / שולם חלקית / שולם במלואו)

### סנכרון עם iCount

#### סנכרון אוטומטי
המערכת מסנכרנת אוטומטית:
- בעת יצירת חשבונית
- בעת עדכון חשבונית
- בעת רישום תשלום

#### סנכרון ידני
מעמוד החשבוניות:
- לחץ כפתור "סנכרון"
- המערכת תסנכרן את כל החשבוניות הממתינות

#### מצב אופליין
- אם אין חיבור לאינטרנט, המערכת תעבוד במצב אופליין
- כל השינויים יישמרו מקומית
- בחזרת החיבור, המערכת תסנכרן אוטומטית

## מבנה הנתונים

### טבלת invoices
```sql
- id: מזהה ייחודי
- order_id: קישור להזמנה
- customer_id: קישור ללקוח
- invoice_number: מספר חשבונית
- invoice_type: סוג מסמך
- issue_date: תאריך הנפקה
- due_date: תאריך תשלום
- subtotal: סכום לפני מע"מ
- vat_amount: סכום מע"מ
- total_amount: סכום כולל
- paid_amount: סכום ששולם
- status: סטטוס (draft/sent/paid/cancelled)
- payment_status: סטטוס תשלום
- icount_doc_id: מזהה מסמך ב-iCount
- sync_status: סטטוס סנכרון
```

### טבלת invoice_items
```sql
- id: מזהה ייחודי
- invoice_id: קישור לחשבונית
- description: תיאור פריט
- quantity: כמות
- unit_price: מחיר יחידה
- vat_rate: אחוז מע"מ
- total: סכום כולל
```

### טבלת invoice_payments
```sql
- id: מזהה ייחודי
- invoice_id: קישור לחשבונית
- payment_date: תאריך תשלום
- amount: סכום
- payment_method: אמצעי תשלום
- reference_number: אסמכתא
```

## Views (תצוגות) למניעת דוחות

### active_invoices
כל החשבוניות הפעילות (לא מבוטלות) עם פרטי לקוח

### invoices_due
חשבוניות הממתינות לתשלום, ממוינות לפי דחיפות

### customer_balances
סיכום חובות לקוחות

## API Endpoints

### חשבוניות
- `GET /api/invoices` - קבלת רשימת חשבוניות
- `POST /api/invoices` - יצירת חשבונית חדשה
- `GET /api/invoices/[id]` - קבלת חשבונית ספציפית
- `PATCH /api/invoices/[id]` - עדכון חשבונית
- `DELETE /api/invoices/[id]` - ביטול חשבונית

### תשלומים
- `POST /api/invoices/[id]/payment` - רישום תשלום

### סנכרון
- `POST /api/invoices/sync` - סנכרון כל החשבוניות
- `POST /api/invoices/sync?invoice_id=X` - סנכרון חשבונית ספציפית

## דוחות עתידיים (בפיתוח)

- דוח הזמנות לקוח
- דוח חייבים
- דוח חשבוניות פתוחות
- דוח חשבוניות שעבר תאריך התשלום שלהן
- דוח פירוט לקוח
- דוח הכנסות חודשי
- דוח מע"מ

## טיפים ושאלות נפוצות

### איך לטפל בחשבונית ששולמה חלקית?
1. גש לדף החשבונית
2. לחץ "רשום תשלום"
3. הזן את הסכום שהתקבל
4. המערכת תעדכן את היתרה אוטומטית

### איך ליצור חשבונית זיכוי?
1. גש למסך החשבוניות
2. צור חשבונית חדשה
3. בחר סוג: "חשבונית זיכוי"
4. קשר לחשבונית המקורית (אופציונלי)

### מה קורה אם הסנכרון נכשל?
- החשבונית נשמרת מקומית
- הסטטוס משתנה ל-"failed"
- ניתן לנסות סנכרון מחדש ידנית
- שגיאת הסנכרון נרשמת ב-sync_log

### איך לבטל חשבונית?
1. גש לדף החשבונית
2. לחץ על "בטל חשבונית"
3. הזן סיבת ביטול
4. החשבונית תסומן כמבוטלת (לא נמחקת!)

## תמיכה טכנית

לשאלות או בעיות, צור issue ב-GitHub או פנה לתמיכה הטכנית.

## רישיון

© 2026 דפוס קשת - כל הזכויות שמורות
